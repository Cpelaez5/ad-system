import{g,s as m,d as f,u as h,i as b,q as E}from"./index-BAFqqIkf.js";const S={async getDocuments(){try{console.log("🔄 Obteniendo documentos desde Supabase...");const{data:e,error:o}=await E("documents","*");if(o)return console.warn("⚠️ Error al obtener documentos desde Supabase, usando fallback:",o.message),await this.getDocumentsFallback();if(console.log("🔍 Datos brutos de documentos:",e),console.log("🔍 Número de documentos brutos:",(e==null?void 0:e.length)||0),!e||!Array.isArray(e))return console.warn("⚠️ Documentos no es un array válido:",e),await this.getDocumentsFallback();const r=e.map(a=>({id:a.id,nombre:a.file_name,tipo:this.getTipoFromExtension(a.file_name),tamaño:a.file_size,categoria:a.category||"Otros",fechaSubida:a.created_at,url:a.file_url,carpeta:this.getCarpetaFromCategory(a.category)}));return console.log("🔍 Documentos transformados:",r),console.log("✅ Documentos obtenidos desde Supabase:",r.length),r}catch(e){return console.error("❌ Error inesperado al obtener documentos:",e),await this.getDocumentsFallback()}},async createDocument(e){try{console.log("🔄 Creando documento en Supabase...");const o={file_name:e.fileName,file_url:e.fileUrl,file_type:e.fileType,file_size:e.fileSize,category:e.category,uploaded_by:e.uploadedBy||"11111111-1111-1111-1111-111111111111"};console.log("📄 Datos del documento a crear:",o);const{data:r,error:a}=await b("documents",o);return a?(console.error("❌ Error al crear documento en Supabase:",a.message),{success:!1,message:"Error al crear documento"}):(console.log("✅ Documento creado exitosamente:",r),{success:!0,data:r})}catch(o){return console.error("❌ Error inesperado al crear documento:",o),{success:!1,message:"Error inesperado al crear documento"}}},async updateDocument(e,o){try{console.log("🔄 Actualizando documento en Supabase...");const r={file_name:o.fileName,category:o.category};console.log("📄 Datos del documento a actualizar:",r);const{data:a,error:l}=await h("documents",e,r);return l?(console.error("❌ Error al actualizar documento en Supabase:",l.message),{success:!1,message:"Error al actualizar documento"}):(console.log("✅ Documento actualizado exitosamente:",a),{success:!0,data:a})}catch(r){return console.error("❌ Error inesperado al actualizar documento:",r),{success:!1,message:"Error inesperado al actualizar documento"}}},async deleteDocument(e){try{console.log("🔄 Eliminando documento en Supabase...");const{data:o,error:r}=await m.from("documents").select("*").eq("id",e).single();if(r)return console.error("❌ Error al obtener documento:",r.message),{success:!1,message:"Error al obtener documento"};console.log("📄 Documento a eliminar:",o);let a=!1;if(o.file_url)try{const c=o.file_url.split("/"),d=c.indexOf("documents");if(d!==-1){const t=c.slice(d+1).join("/");console.log("🗑️ Eliminando archivo del Storage:",t);const{error:n}=await m.storage.from("documents").remove([t]);if(n){console.warn("⚠️ Error al eliminar archivo del Storage:",n.message);const s=[t,t.replace(/^[^/]+\//,""),t.split("/").slice(1).join("/")];for(const i of s)if(i!==t){console.log(`🔄 Intentando ruta alternativa: ${i}`);const{error:p}=await m.storage.from("documents").remove([i]);if(!p){console.log(`✅ Archivo eliminado con ruta alternativa: ${i}`),a=!0;break}}}else console.log("✅ Archivo eliminado del Storage exitosamente"),a=!0}else console.warn("⚠️ No se pudo extraer la ruta del archivo de la URL:",o.file_url)}catch(c){console.warn("⚠️ Error al procesar eliminación del Storage:",c)}const{data:l,error:u}=await f("documents",e);return u?(console.error("❌ Error al eliminar documento en Supabase:",u.message),{success:!1,message:"Error al eliminar documento"}):(console.log("✅ Documento eliminado exitosamente:",l),{success:!0,data:l,storageDeleted:a})}catch(o){return console.error("❌ Error inesperado al eliminar documento:",o),{success:!1,message:"Error inesperado al eliminar documento"}}},async uploadFile(e,o){try{console.log("🔄 Subiendo archivo a Supabase Storage...");const r=g(),a=Date.now(),l=Math.random().toString(36).substring(2,15),u=e.name.split(".").pop(),d=`${e.name.replace(/\.[^/.]+$/,"")}_${a}_${l}.${u}`,t=`${r}/${o}/${d}`;console.log("📁 Ruta del archivo:",t);const{data:n,error:s}=await m.storage.from("documents").upload(t,e);if(s)return console.error("❌ Error al subir archivo:",s),{success:!1,message:"Error al subir archivo"};const{data:i}=m.storage.from("documents").getPublicUrl(t);return console.log("✅ Archivo subido exitosamente:",n),console.log("🔗 URL pública:",i.publicUrl),{success:!0,data:{fileName:n.path,fileUrl:i.publicUrl,fileType:e.type,fileSize:e.size,originalName:e.name}}}catch(r){return console.error("❌ Error inesperado al subir archivo:",r),{success:!1,message:"Error inesperado al subir archivo"}}},async getDocumentStats(){try{console.log("🔄 Obteniendo estadísticas de documentos desde Supabase...");const e=g(),{data:o,error:r}=await m.from("documents").select("*").eq("organization_id",e);if(r)return console.warn("⚠️ Error al obtener documentos para estadísticas:",r.message),{total:0,byCategory:{},totalSize:0,uploadsToday:0};const a=o.length,l={};let u=0,c=0;const d=new Date().toISOString().split("T")[0];o.forEach(n=>{const s=n.category||"Otros";l[s]=(l[s]||0)+1,u+=n.file_size||0,n.created_at&&n.created_at.startsWith(d)&&c++});const t={total:a,byCategory:l,totalSize:u,uploadsToday:c};return console.log("✅ Estadísticas de documentos calculadas:",t),t}catch(e){return console.error("❌ Error al obtener estadísticas de documentos:",e),{total:0,byCategory:{},totalSize:0,uploadsToday:0}}},getTipoFromExtension(e){const o=e.split(".").pop().toLowerCase();return{pdf:"PDF",xlsx:"Excel",xls:"Excel",docx:"Word",doc:"Word",jpg:"Imagen",jpeg:"Imagen",png:"Imagen",gif:"Imagen"}[o]||"Otro"},getCarpetaFromCategory(e){return{Facturas:1,Comprobantes:2,Contratos:3,Reportes:4,Certificados:5}[e]||1},async cleanupOrphanedFiles(){try{console.log("🧹 Limpiando archivos huérfanos del Storage...");const e=g(),{data:o,error:r}=await m.storage.from("documents").list(e,{limit:1e3,sortBy:{column:"created_at",order:"desc"}});if(r)return console.error("❌ Error al listar archivos del Storage:",r),{success:!1,message:"Error al listar archivos del Storage"};const{data:a,error:l}=await m.from("documents").select("file_url").eq("organization_id",e);if(l)return console.error("❌ Error al obtener documentos de la BD:",l),{success:!1,message:"Error al obtener documentos de la BD"};const u=a.map(t=>{const n=t.file_url.split("/");return n.slice(n.indexOf("documents")+1).join("/")}),c=[],d=(t,n="")=>{if(!Array.isArray(t)){console.warn("⚠️ files no es un array:",t);return}t.forEach(s=>{if(!s||!s.name)return;const i=n?`${n}/${s.name}`:s.name;s.metadata&&s.metadata.mimetype?u.includes(i)||c.push(i):s.name&&!s.metadata&&d(s,i)})};if(d(o),c.length>0){console.log(`🗑️ Encontrados ${c.length} archivos huérfanos:`,c);const{error:t}=await m.storage.from("documents").remove(c);return t?(console.error("❌ Error al eliminar archivos huérfanos:",t),{success:!1,message:"Error al eliminar archivos huérfanos"}):(console.log("✅ Archivos huérfanos eliminados exitosamente"),{success:!0,deletedCount:c.length})}else return console.log("✅ No se encontraron archivos huérfanos"),{success:!0,deletedCount:0}}catch(e){return console.error("❌ Error inesperado al limpiar archivos huérfanos:",e),{success:!1,message:"Error inesperado al limpiar archivos huérfanos"}}},async getDocumentsFallback(){return console.log("🔄 Usando fallback para documentos..."),[{id:1,nombre:"Factura_001_2024.pdf",tipo:"PDF",tamaño:245760,categoria:"Facturas",fechaSubida:"2024-01-20",carpeta:1},{id:2,nombre:"Comprobante_Pago_001.xlsx",tipo:"Excel",tamaño:51200,categoria:"Comprobantes",fechaSubida:"2024-01-19",carpeta:2}]}};export{S as default};
